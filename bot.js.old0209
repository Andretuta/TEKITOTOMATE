require('dotenv').config();
const fs = require('fs');
const path = require('path');
const express = require('express');
const axios = require('axios');
const qrcode = require('qrcode-terminal');
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const TelegramBot = require('node-telegram-bot-api');

// === Caminhos ===
const LOG_FILE = path.join(__dirname, 'logs', 'bot.log');
const WHATSAPP_GROUPS_DB = path.join(__dirname, 'groups.json');
const TELEGRAM_CHATS_DB = path.join(__dirname, 'telegram_chats.json');
const ADMINS_FILE = path.join(__dirname, 'bot_admins.json');
if (!fs.existsSync(path.dirname(LOG_FILE))) fs.mkdirSync(path.dirname(LOG_FILE));

// === Utils ===
const readJson = (file) => fs.existsSync(file) ? JSON.parse(fs.readFileSync(file, 'utf8')) : [];
const writeJson = (file, data) => fs.writeFileSync(file, JSON.stringify(data, null, 2));
const log = (...msg) => {
    const line = `[${new Date().toISOString()}] ${msg.join(' ')}\n`;
    fs.appendFileSync(LOG_FILE, line);
    console.log(...msg);
};
const getAdmins = () => {
    try {
        const data = JSON.parse(fs.readFileSync(ADMINS_FILE, 'utf8'));
        return Array.isArray(data.admins) ? data.admins : [];
    } catch { return []; }
};

// === WHATSAPP ===
const wpp = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: { headless: true, args: ['--no-sandbox', '--disable-setuid-sandbox'] }
});
wpp.on('qr', qr => qrcode.generate(qr, { small: true }));
wpp.on('ready', () => log('‚úÖ WhatsApp pronto!'));
wpp.on('auth_failure', msg => log('‚ùå Auth WhatsApp:', msg));
wpp.on('disconnected', reason => log('‚ùå WhatsApp desconectado:', reason));

// Auto cadastro/remocao de grupos
wpp.on('group_join', notif => {
    const groups = readJson(WHATSAPP_GROUPS_DB);
    if (!groups.includes(notif.chatId)) {
        groups.push(notif.chatId);
        writeJson(WHATSAPP_GROUPS_DB, groups);
        log('üü¢ Entrou em grupo WhatsApp:', notif.chatId);
    }
});
wpp.on('group_leave', notif => {
    const updated = readJson(WHATSAPP_GROUPS_DB).filter(id => id !== notif.chatId);
    writeJson(WHATSAPP_GROUPS_DB, updated);
    log('üî¥ Saiu de grupo WhatsApp:', notif.chatId);
});

// === TELEGRAM ===
let telegramBot = null;
const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;

if (TELEGRAM_TOKEN) {
    telegramBot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });
    log('‚úÖ Telegram bot iniciado');

    telegramBot.on('my_chat_member', (data) => {
        const chat = data.chat;
        const chats = readJson(TELEGRAM_CHATS_DB);

        if (['member', 'administrator'].includes(data.new_chat_member?.status)) {
            if (!chats.includes(chat.id)) {
                chats.push(chat.id);
                writeJson(TELEGRAM_CHATS_DB, chats);
                log('üü¢ Adicionado a grupo/canal Telegram:', chat.id);
            }
        }

        if (['left', 'kicked'].includes(data.new_chat_member?.status)) {
            const filtered = chats.filter(id => id !== chat.id);
            writeJson(TELEGRAM_CHATS_DB, filtered);
            log('üî¥ Removido de grupo/canal Telegram:', chat.id);
        }
    });

    telegramBot.on('message', (msg) => {
        const chats = readJson(TELEGRAM_CHATS_DB);
        if (!chats.includes(msg.chat.id)) {
            chats.push(msg.chat.id);
            writeJson(TELEGRAM_CHATS_DB, chats);
            telegramBot.sendMessage(msg.chat.id, '‚úÖ Chat registrado com sucesso!');
        }
    });
} else {
    log('‚ö†Ô∏è TELEGRAM_TOKEN n√£o configurado.');
}

// === MIDIA ===
async function getMediaFromUrl(url) {
    try {
        const res = await axios.get(url, { responseType: 'arraybuffer' });
        const mime = res.headers['content-type'];
        const base64 = Buffer.from(res.data, 'binary').toString('base64');
        return new MessageMedia(mime, base64, 'image');
    } catch (err) {
        log('‚ùå Erro ao baixar imagem:', err.message);
        return null;
    }
}

// === ENVIO CORRIGIDO ===
async function sendToAll(message, imageUrl = null, directMedia = null) {
    const wppGroups = readJson(WHATSAPP_GROUPS_DB);
    const tgChats = readJson(TELEGRAM_CHATS_DB);
    let media = directMedia; // Usar m√≠dia j√° baixada se fornecida

    // Se n√£o h√° m√≠dia direta, tentar baixar da URL
    if (!media && imageUrl) {
        media = await getMediaFromUrl(imageUrl);
    }

    log('üì§ Enviando para grupos...', { 
        hasMedia: !!media, 
        hasUrl: !!imageUrl, 
        wppGroups: wppGroups.length, 
        tgChats: tgChats.length 
    });

    // WhatsApp
    for (const id of wppGroups) {
        try {
            if (media) {
                // Enviar m√≠dia com caption
                await wpp.sendMessage(id, media, { caption: message || '' });
                log('‚úÖ M√≠dia enviada WhatsApp:', id);
            } else {
                // Enviar apenas texto
                await wpp.sendMessage(id, message);
                log('‚úÖ Texto enviado WhatsApp:', id);
            }
        } catch (e) {
            log('‚ùå Falha WhatsApp:', id, e.message);
        }
    }

    // Telegram
    if (telegramBot) {
        for (const id of tgChats) {
            try {
                if (media && imageUrl) {
                    // Para Telegram, usar URL se dispon√≠vel
                    await telegramBot.sendPhoto(id, imageUrl, { caption: message || '' });
                    log('‚úÖ M√≠dia enviada Telegram (URL):', id);
                } else if (media && media.data) {
                    // Converter m√≠dia direta para buffer para Telegram
                    const buffer = Buffer.from(media.data, 'base64');
                    await telegramBot.sendPhoto(id, buffer, { caption: message || '' });
                    log('‚úÖ M√≠dia enviada Telegram (buffer):', id);
                } else {
                    // Enviar apenas texto
                    await telegramBot.sendMessage(id, message);
                    log('‚úÖ Texto enviado Telegram:', id);
                }
            } catch (e) {
                log('‚ùå Falha Telegram:', id, e.message);
            }
        }
    }
}

// === WHATSAPP COMANDOS PRIVADOS (ADM) - CORRIGIDO ===
wpp.on('message', async (msg) => {
    const sender = msg.from;
    if (!sender.endsWith('@c.us')) return;
    const senderNumber = sender.replace('@c.us', '');
    const admins = getAdmins();
    
    if (!admins.includes(senderNumber)) {
        log('‚õî Tentativa de comando n√£o autorizada:', senderNumber);
        return;
    }

    if (msg.body.trim().toLowerCase() === 'status') {
        const wppGroups = readJson(WHATSAPP_GROUPS_DB);
        const tgChats = readJson(TELEGRAM_CHATS_DB);
        await msg.reply(`üìä *Status do Bot:*\nWhatsApp: ${wppGroups.length} grupos\nTelegram: ${tgChats.length} chats`);
        return;
    }

    // L√≥gica de envio CORRIGIDA
    let content = msg.body;
    let media = null;
    let imageUrl = null;

    try {
        if (msg.hasMedia) {
            // Baixar m√≠dia enviada diretamente
            log('üì• Baixando m√≠dia do WhatsApp...');
            media = await msg.downloadMedia();
            log('‚úÖ M√≠dia baixada:', { mimetype: media.mimetype, size: media.data?.length });
        } else if (/https?:\/\/.+\.(jpg|jpeg|png|gif|mp4|mov|avi)/i.test(content)) {
            // URL de m√≠dia detectada
            imageUrl = content.trim();
            log('üîó URL de m√≠dia detectada:', imageUrl);
            content = ''; // Limpar texto pois √© s√≥ URL
        }

        const wppGroups = readJson(WHATSAPP_GROUPS_DB);
        const tgChats = readJson(TELEGRAM_CHATS_DB);
        
        if (wppGroups.length === 0 && tgChats.length === 0) {
            await msg.reply('‚ùå Nenhum grupo ou canal registrado.');
            return;
        }

        // Chamar sendToAll com m√≠dia direta se dispon√≠vel
        await sendToAll(
            content || 'üì£ Nova mensagem!', 
            imageUrl, 
            media  // <- CORRE√á√ÉO: Passar m√≠dia baixada diretamente
        );
        
        await msg.reply('‚úÖ Enviado para todos os grupos!');
        
    } catch (error) {
        log('‚ùå Erro ao processar mensagem:', error.message);
        await msg.reply('‚ùå Erro ao processar mensagem.');
    }
});

// === API EXPRESS ===
const app = express();
app.use(express.json());
const PORT = process.env.PORT || 3000;

app.post('/send-to-all', async (req, res) => {
    const { message, imageUrl } = req.body;
    if (!message && !imageUrl) {
        return res.status(400).json({ success: false, error: 'Mensagem ou imagem obrigat√≥ria.' });
    }

    try {
        await sendToAll(message || '', imageUrl);
        res.json({ success: true, message: 'Enviado com sucesso.' });
    } catch (error) {
        log('‚ùå Erro na API:', error.message);
        res.status(500).json({ success: false, error: 'Erro interno.' });
    }
});

app.listen(PORT, () => log(`üöÄ API rodando na porta ${PORT}`));
wpp.initialize();
